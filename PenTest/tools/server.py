from flask import Flask, abort, redirect, url_for, render_template, request
from flask_cors import CORS, cross_origin
import json
import os
import stagedata as stage

rootDir = '../output/'
app = Flask(__name__, template_folder=rootDir)
CORS(app)


@app.route('/')
def root():
    return render_template('index.json')


@app.route('/<path:path>')
def get_dir(path):
    return stage.get_subdomains(path)


@app.route('/getPendingScans', methods=['GET'])
def get_pending_scans():
    return stage.get_pending_domains()


@app.route('/deletePendingScan', methods=['POST'])
def delete_pending_scan():
    if request.method == 'POST':
        data = request.form

    return json.dumps({'success': stage.delete_pending_domain(data['name'])}), 501, {'ContentType': 'application/json'}


@app.route('/getAvailableDomains', methods=['GET'])
def get_available_domains():
    return stage.get_domains()


@app.route('/addDomain', methods=['GET', 'POST', 'DELETE'])
def add_domain():
    if request.method == 'POST':
        data = request.form  # a multi-dict containing POST data
        stage.add_pending_domain(data['name'])

        return json.dumps({'success': True}), 200, {'ContentType': 'application/json'}


@app.route('/scanDomains', methods=['GET'])
def scan_domain():
    try:
        os.system("python graph-data.py")
        return json.dumps({'success': True}), 200, {'ContentType': 'application/json'}
    except IOError:
        return json.dumps({'success': IOError}), 200, {'ContentType': 'application/json'}


if __name__ == "__main__":
    app.run(debug=True, host='0.0.0.0')
