import json
import os
import formatdata as format
import stagedata as stage

format.database_tables()
domain_list = json.loads(stage.get_pending_domains())

for domain in domain_list:
    line = domain['name']
    domain_list += line.split('.')[0]
    if line:
        print("********* " + line + " *********")
        outfile = '../output/' + line.split('.')[0] + '/'
        filename = line.split('.')[0] + '.json'
        # os.system('mkdir -p ' + outfile)
        # os.system('rm -f ' + outfile + line.split('.')[0] + '.json')
        amass = '~/.linuxbrew/bin/amass enum -d ' + line + \
            ' -json ' + outfile + filename + ' >/dev/null'
        # os.system(amass)
        stage.subdomains_to_db(file=outfile+filename)
        # Load as data frame and display
        format.subdomains_to_json(outfile=outfile + filename, domain=line)

with open('../output/index.json', 'w') as outfile:
    outfile.write(json.dumps(os.listdir("../output")))

os.system('rm ../input/domains/domains.txt')
