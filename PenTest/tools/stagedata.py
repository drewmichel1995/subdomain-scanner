import sqlite3
import json
import formatdata as format


# Inserts subdomains into database
def subdomains_to_db(file):
    # Create database connection
    db_filename = '../data/PenTest.db'
    connection = sqlite3.connect(db_filename)

    subdomains = json.loads(format.amass_data(file=file))

    # Insert each subdomain and address into the database
    for subdom in subdomains['results']:
      connection.execute("""
      INSERT OR REPLACE INTO subdomains (domain, name, source, tag)
      VALUES (?, ?, ?, ?)
      """, (subdom['domain'], subdom['name'], subdom['source'], subdom['tag']))

      for address in subdom['addresses']:
        connection.execute("""
        INSERT OR REPLACE INTO addresses (domain, name, ip, cidr, asn, desc)
        VALUES (?, ?, ?, ?, ?, ?)
        """, (subdom['domain'], subdom['name'], address['ip'], address['cidr'],
              address['asn'], address['desc']))

    connection.commit()
    connection.close()
